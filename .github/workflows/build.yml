name: Build and smoke test docker image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      # PostgreSQL service container
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: notimon_test
          POSTGRES_PASSWORD: notimon_test
          POSTGRES_DB: notimon_test
        ports:
          - 5432:5432
        # Health check to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Build Docker image
        run: |
            docker build . -t notimon
            docker run \
                --detach \
                --name notimon \
                --publish 3000:3000 \
                -e DATABASE_URL=postgresql://notimon_test:notimon_test@postgres:5432/notimon_test \
                notimon:latest
            curl --silent \
                 --fail-with-body \
                 --show-error \
                 --retry 5 \
                 --retry-max-time 120 \
                 http://localhost:3000 | grep "Get started by editing"
      - run: docker logs notimon